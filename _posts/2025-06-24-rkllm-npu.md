---
layout: post
title: rk3588å¤§æ¨¡å‹ä¸Šæ‰‹ä½“éªŒ
date: 2025-06-24 11:07
mathjax: false
disqus: true
categories: AI
---

> è¿‡å°½åƒå¸†çš†ä¸æ˜¯ï¼Œæ–œæ™–è„‰è„‰æ°´æ‚ æ‚ ï¼Œè‚ æ–­ç™½é¢‘æ´²

ç»§ä¸Šä¸ªæœˆåˆ°æ‰‹å›½äº§æ ‘æ¯’æ´¾åï¼Œåˆ·å®˜æ–¹ç³»ç»ŸæŠŠç©äº†ä¸€ç•ªã€‚å‚è€ƒäº†ä¸€äº›è®ºå›å’Œåšå®¢åï¼Œå†³å®šæ¢å…¶å®ƒç³»ç»Ÿç©ç©ã€‚ç„¶åå‘ç°å¤§æ¨¡å‹åœ¨rkç³»åˆ—çš„NPUä¸Šå¯ä»¥è·‘ä¸€äº›è’¸é¦ç‰ˆæœ¬ï¼Œäºæ˜¯ä¾¿å¼€å§‹ä½“éªŒä¸€ä¸‹ã€‚

---

### rknnå¤§æ¨¡å‹éƒ¨ç½²

å®˜æ–¹çš„å¤§æ¨¡å‹ä¸»è¦æ˜¯cå’Œc++çš„ä¸€äº›åº“å’Œdemoç»„æˆï¼Œå‚è€ƒ[å®˜æ–¹æ–‡æ¡£å®‰è£…RKNNç¯å¢ƒ](https://docs.radxa.com/rock5/rock5b/app-development/rknn_install)ã€‚é€šè¿‡ä¸‹é¢å‘½ä»¤å¯ä»¥æŸ¥çœ‹ç›®å‰npué©±åŠ¨ç‰ˆæœ¬ï¼š

```bash
    sudo dmesg | grep "Initialized rknpu"
```

æ ¹æ®æ¿ç«¯ç³»ç»Ÿçš„ **python ç‰ˆæœ¬**å°†å¯¹åº”çš„ `rknn_toolkit_lite2-2.3.0-cp3X-cp3X-manylinux_2_17_aarch64.manylinux2014_aarch64.whl` å¤åˆ¶åˆ°æ¿ç«¯ï¼Œè¿›å…¥è™šæ‹Ÿç¯å¢ƒåä½¿ç”¨ pip3 å®‰è£…

```bash
pip3 install ./rknn_toolkit_lite2-2.3.0-cp3X-cp3X-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
```

ç„¶åå®‰è£…rknn-toolkit2:

```bash
pip install -U rknn-toolkit2
```

å®‰è£…rknn-toolkit2 libï¼š

```bash
wget https://raw.githubusercontent.com/airockchip/rknn-toolkit2/refs/heads/master/rknpu2/runtime/Linux/librknn_api/aarch64/librknnrt.so
sudo cp librknnrt.so /usr/lib/
```
---

#### Yoloç³»åˆ—

ç›®å‰æœ€æ–°çš„yolo11ç‰ˆæœ¬å·²ç»å¯ä»¥é€šè¿‡ultralyticsåº“æ¥è°ƒç”¨å’Œè¿è¡Œï¼Œç›¸å…³å¤§æ¨¡å‹æƒé‡æ–‡ä»¶åœ¨[å®˜æ–¹æ–‡æ¡£](https://docs.radxa.com/rock5/rock5b/app-development/rknn_ultralytics)ä¸­å¯ä»¥æŸ¥çœ‹ä¸‹è½½ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ultralyticsåº“æ¥è‡ªå·±è½¬æ¢æƒé‡ä¸ºrknnæ–‡ä»¶ã€‚æ³¨æ„**è°ƒç”¨æ—¶è¦å¸¦ä¸Š`metadata.yaml`æ–‡ä»¶ï¼Œæƒé‡æ–‡ä»¶è·¯å¾„ä¸è¦åŠ åç¼€.rknn**ï¼Œä¸‹é¢æ˜¯æµ‹è¯•è„šæœ¬ï¼š

```bash
#!/bin/bash

yolo predict model='./yolo11n_3588_rknn_model' source='https://ultralytics.com/images/bus.jpg'
```

pythonæµ‹è¯•è„šæœ¬å¦‚ä¸‹ï¼š

```python
from ultralytics import YOLO

# Load the exported RKNN model
rknn_model = YOLO("./yolo11n_3588_rknn_model")

# Run inference
results = rknn_model("https://ultralytics.com/images/bus.jpg")
```

---

#### Deepseekè’¸é¦æ¨¡å‹

å‚è€ƒ[å®˜æ–¹çš„æ–‡ä»¶](https://docs.radxa.com/rock5/rock5b/app-development/rkllm_deepseek_r1)ï¼Œå¯ä»¥ç”¨c++æ¥éƒ¨ç½²ï¼Œä½†æ˜¯è¿˜æ˜¯æ›´ä¹ æƒ¯ç”¨pythonæ¥éƒ¨ç½²ã€‚RKNNâ€‘LLMï¼ˆåˆå RKLLMï¼‰ç›®å‰æ²¡æœ‰å®˜æ–¹ Python æ¥å£ç”¨äºç›´æ¥åœ¨è„šæœ¬ä¸­è°ƒç”¨æ¨ç†åŠŸèƒ½ã€‚ç†è§£å®ƒçš„è¿è¡Œæœºåˆ¶å¦‚ä¸‹ï¼š
ğŸ§  å½“å‰ SDK æ¶æ„
1. RKLLMâ€‘Toolkitï¼ˆPC ç«¯æ¨¡å‹è½¬æ¢å·¥å…·ï¼‰
â€“ æä¾› Python APIï¼Œç”¨äºå°† HuggingFace æ ¼å¼æ¨¡å‹å¯¼å‡ºä¸º .rkllm æ–‡ä»¶ï¼Œå¯è¿›è¡Œé‡åŒ–ä¸å¹³å°ä¼˜åŒ–ã€‚
2. RKLLM Runtimeï¼ˆæ¿ç«¯æ¨ç†åº“ï¼‰
â€“ è¿è¡Œäº RK3588/RK3576 ç­‰è®¾å¤‡ä¸Šçš„ C/C++ åŠ¨æ€åº“ï¼Œç”Ÿæˆ .rkllm åéœ€é€šè¿‡è°ƒç”¨ C æ¥å£è¿›è¡Œæ¨ç†ã€‚
3. ç¤ºä¾‹é¡¹ç›®ï¼ˆC++ demoã€shell è„šæœ¬ç­‰ï¼‰
â€“ GitHub ä¸Šæä¾›çš„ç¤ºä¾‹å¤šä¸º C/C++ å½¢å¼ï¼Œè€Œé Pythonã€‚

æ‰€ä»¥è¿™é‡Œæˆ‘åˆ©ç”¨ ctypes æˆ– cffi å°è£… C æ¥å£ï¼ˆå¦‚ rkllm_initã€rkllm_inferã€rkllm_releaseï¼‰ï¼Œä¸º Python æä¾›ç»‘å®šæ¥å£ã€‚âœ… ctypes æ˜¯æœ€è½»é‡çº§ã€æœ€å¸¸ç”¨çš„åšæ³•ã€‚

---

##### âœ… ä½¿ç”¨å‰æ

å·²æœ‰ RKNN-LLM æ¨ç†åº“ï¼Œæ¯”å¦‚ï¼š
+ åŠ¨æ€åº“å°è£…çš„å¤´æ–‡ä»¶ï¼Œå®˜æ–¹åœ¨githubä»“åº“ä¸­ç»™å‡º
+ åŠ¨æ€åº“è·¯å¾„ï¼š/usr/lib/librkllm_runtime.so
+ æ¨¡å‹æ–‡ä»¶ï¼šchatglm3.rkllm
+ ä½ äº†è§£æ¨ç†è¾“å…¥è¾“å‡ºæ ¼å¼ï¼ˆä¾‹å¦‚æ˜¯å­—ç¬¦ä¸²ï¼Œè¿˜æ˜¯ token IDï¼‰

---

##### ğŸ“¦ ç¤ºä¾‹ç›®å½•ç»“æ„

```bash
DeepSeek-R1-Distill-Qwen-1.5B_RKLLM/
â”œâ”€â”€ python/
â”‚   â”œâ”€â”€ rkllm_wrapper.py
â”‚   â””â”€â”€ run.py
â”œâ”€â”€ demo_Linux_aarch64/
â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ librkllmrt.so
â”œâ”€â”€ DeepSeek-R1-Distill-Qwen-1.5B_W8A8_RK3588.rkllm
```

---

##### âš ï¸ å¯é€‰ï¼šè®¾ç½® LD_LIBRARY_PATH

å¦‚æœé‡åˆ° .so åŠ è½½é—®é¢˜ï¼Œå»ºè®®åœ¨è¿è¡Œå‰ï¼š
```bash
export LD_LIBRARY_PATH=../demo_Linux_aarch64/lib:$LD_LIBRARY_PATH
```

---

##### ğŸ§°æ­¥éª¤è¯¦è§£ï¼šç”¨ `ctypes` å°è£… `.so` å’Œå¤´æ–‡ä»¶

- 1ï¸âƒ£ **å‡†å¤‡å¤´æ–‡ä»¶ï¼ˆä¾‹å¦‚ `rkllm.h`ï¼‰**

ä» GitHub ä¸Š [rkllm.h](https://github.com/airockchip/rknn-llm/blob/main/rkllm-runtime/Linux/librkllm_api/include/rkllm.h) çœ‹ï¼Œä½ æœ‰ç±»ä¼¼ä¸‹é¢çš„ç»“æ„ï¼š

```c
typedef struct {
    char* model_path;
    int context_len;
    float temperature;
} rkllm_param;

int rkllm_init(rkllm_param* param);
char* rkllm_run(const char* input);
```

---

- 2ï¸âƒ£ **åŠ è½½ `.so` æ–‡ä»¶ï¼ˆå¦‚ `librkllmrt.so`ï¼‰**

```python
import ctypes
from ctypes import *

# åŠ è½½ so æ–‡ä»¶
rkllm = ctypes.CDLL("/path/to/librkllmrt.so")  # æ³¨æ„è·¯å¾„
```

---

- 3ï¸âƒ£ **å®šä¹‰ç»“æ„ä½“ `rkllm_param`ï¼ˆå¯¹åº” C çš„ç»“æ„ï¼‰**

```python
class rkllm_param(Structure):
    _fields_ = [
        ("model_path", c_char_p),
        ("context_len", c_int),
        ("temperature", c_float)
    ]
```

---

- 4ï¸âƒ£ **å®šä¹‰å‡½æ•°ç­¾å**

```python
# int rkllm_init(rkllm_param* param);
rkllm.rkllm_init.argtypes = [POINTER(rkllm_param)]
rkllm.rkllm_init.restype = c_int

# const char* rkllm_run(const char* input);
rkllm.rkllm_run.argtypes = [c_char_p]
rkllm.rkllm_run.restype = c_char_p
```

---

- 5ï¸âƒ£ **è°ƒç”¨å‡½æ•°**

```python
# å‡†å¤‡å‚æ•°ç»“æ„ä½“
param = rkllm_param(
    model_path=b"/path/to/model.bin",   # æ³¨æ„è¦æ˜¯ bytes ç±»å‹
    context_len=512,
    temperature=0.8
)

# åˆå§‹åŒ–
ret = rkllm.rkllm_init(byref(param))
print("init returned", ret)

# æ¨ç†
output = rkllm.rkllm_run(b"ä½ å¥½ï¼Œè¯·é—®ä½ æ˜¯è°ï¼Ÿ")
print("output:", output.decode())
```

---

##### **Python è°ƒç”¨ `.so` çš„æœ¬è´¨æµç¨‹**

1. `.so` æœ¬è´¨æ˜¯ ELF æ ¼å¼å…±äº«åº“ï¼Œå¯¼å‡ºç¬¦å·å‡½æ•°å¦‚ `rkllm_run`ï¼›
2. `ctypes.CDLL` æˆ– `cdll.LoadLibrary` ä¼šè¯»å–åŠ¨æ€åº“ç¬¦å·è¡¨ï¼›
3. ä½ éœ€è¦è®¾ç½® `.argtypes` å’Œ `.restype` å‘Šè¯‰ Python å‚æ•°ç±»å‹ï¼›
4. `ctypes.Structure` æ˜ å°„ `C struct`ï¼›
5. Python è°ƒç”¨æ—¶ï¼Œåº•å±‚é€šè¿‡ FFIï¼ˆForeign Function Interfaceï¼‰ä¼ å‚ã€æ‰§è¡Œå¹¶è¿”å›ç»“æœã€‚

---

##### **å¸¸è§é—®é¢˜æç¤º**

| é—®é¢˜ç±»å‹                 | åŸå› æˆ–è§£å†³æ–¹å¼                                |
| -------------------- | -------------------------------------- |
| `Segmentation fault` | å‚æ•°ä¼ é”™ï¼ˆå¦‚ç»“æ„ä½“æ²¡åˆå§‹åŒ–æ­£ç¡®ã€å†…å­˜è¶Šç•Œï¼‰                  |
| Python crash         | `restype` æˆ– `argtypes` æ²¡å®šä¹‰æˆ–é”™è¯¯          |
| å­—ç¬¦ä¸²ä¹±ç                 | åº”ä½¿ç”¨ `c_char_p` ä¸”ä¼ å…¥ `bytes` ç±»å‹          |
| è¿”å›ç»“æ„ä½“                | ç”¨ `POINTER(MyStruct)` + `.contents` æå– |

---

##### **æ˜¯å¦éœ€è¦è‡ªåŠ¨è§£æå¤´æ–‡ä»¶ï¼Ÿ**

ä½ ä¹Ÿå¯ä»¥ç”¨å·¥å…·è‡ªåŠ¨å°† `.h` å¤´æ–‡ä»¶è½¬æ¢ä¸º Python ç»“æ„ï¼Œæ¯”å¦‚ï¼š

* [`ctypesgen`](https://github.com/ctypesgen/ctypesgen)ï¼šè‡ªåŠ¨è¯»å– `.h` å’Œ `.so` ç”Ÿæˆ `.py`
* [`CFFI`](https://cffi.readthedocs.io/)ï¼šé€‚ç”¨äºæ›´å¤æ‚çš„ç»‘å®šï¼ˆéœ€è¦æ‰‹åŠ¨æˆ– C ç¼–è¯‘ï¼‰
* [`pybind11`](https://github.com/pybind/pybind11)ï¼šC++ å±‚åŒ…è£…ï¼Œéå¸¸ä¼˜é›…ä½†éœ€é‡æ–°ç¼–è¯‘

##### ğŸ” è¡¥å……è¯´æ˜

ä¸‹é¢æ˜¯Python `ctypes` å°è£…ä»£ç ï¼Œç”¨äºè°ƒç”¨ `rkllm.h` ä¸­å®šä¹‰çš„æ‰€æœ‰ç»“æ„ä½“ã€æšä¸¾å’Œå‡½æ•°ï¼š

```python
import ctypes
from ctypes import c_int, c_float, c_char_p, c_bool, c_void_p, POINTER, Structure, Union, c_size_t, c_int8, c_uint32, c_ubyte

# â€”â€” å¸¸é‡å®šä¹‰ â€”â€” 
CPU0 = 1 << 0
CPU1 = 1 << 1
# â€¦ åŒç† CPU2â€“CPU7

# â€”â€” æšä¸¾å€¼ â€”â€” 
RKLLM_RUN_NORMAL = 0
RKLLM_RUN_WAITING = 1
RKLLM_RUN_FINISH = 2
RKLLM_RUN_ERROR = 3

...

# â€”â€” ç»“æ„ä½“å®šä¹‰ â€”â€” 
class RKLLMExtendParam(Structure):
    _fields_ = [
        ("base_domain_id", c_int),
        ("embed_flash", c_int8),
        ("enabled_cpus_num", c_int8),
        ("enabled_cpus_mask", c_uint32),
        ("reserved", c_ubyte * 106),
    ]

class RKLLMParam(Structure):
    _fields_ = [
        ("model_path", c_char_p),
        ("max_context_len", c_int),
        ("max_new_tokens", c_int),
        ("top_k", c_int),
        ("n_keep", c_int),
        ("top_p", c_float),
        ("temperature", c_float),
        ("repeat_penalty", c_float),
        ("frequency_penalty", c_float),
        ("presence_penalty", c_float),
        ("mirostat", c_int),
        ("mirostat_tau", c_float),
        ("mirostat_eta", c_float),
        ("skip_special_token", c_bool),
        ("is_async", c_bool),
        ("img_start", c_char_p),
        ("img_end", c_char_p),
        ("img_content", c_char_p),
        ("extend_param", RKLLMExtendParam),
    ]

class RKLLMLoraAdapter(Structure):
    _fields_ = [
        ("lora_adapter_path", c_char_p),
        ("lora_adapter_name", c_char_p),
        ("scale", c_float),
    ]

...

class RKLLMInputUnion(Union):
    _fields_ = [
        ("prompt_input", c_char_p),
        ("embed_input", RKLLMEmbedInput),
        ("token_input", RKLLMTokenInput),
        ("multimodal_input", RKLLMMultiModelInput),
    ]

class RKLLMInput(Structure):
    _anonymous_ = ("input",)
    _fields_ = [
        ("input_type", c_int),
        ("input", RKLLMInputUnion),
    ]

...

class RKLLMInferParam(Structure):
    _fields_ = [
        ("mode", c_int),
        ("lora_params", POINTER(RKLLMLoraParam)),
        ("prompt_cache_params", POINTER(RKLLMPromptCacheParam)),
        ("keep_history", c_int),
    ]

...

# â€”â€” ç±»å‹å®šä¹‰ â€”â€” 
LLMHandle = c_void_p
LLMResultCallback = ctypes.CFUNCTYPE(None, POINTER(RKLLMResult), c_void_p, c_int)

# â€”â€” åŠ è½½ SO åº“å¹¶è®¾ç½®å‡½æ•°ç­¾å â€”â€” 
rkllm = ctypes.cdll.LoadLibrary("librkllmrt.so")

rkllm.rkllm_createDefaultParam.restype = RKLLMParam

...

```

---

`callback` å‡½æ•°æ˜¯ä¸€ä¸ª C å›è°ƒï¼Œç”¨äºå¤„ç†æ¨¡å‹æ¨ç†çš„ç»“æœï¼ˆå¦‚æ–‡æœ¬ã€éšè—å±‚ã€é”™è¯¯çŠ¶æ€ç­‰ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥å°†å®ƒå®Œæ•´è½¬æ¢ä¸º Python çš„ `ctypes` å›è°ƒå‡½æ•°ï¼Œä¿ç•™æ‰€æœ‰é€»è¾‘ï¼ŒåŒ…æ‹¬ä¿å­˜éšè—å±‚è¾“å‡ºã€‚

âœ… Python å›è°ƒè½¬æ¢å¦‚ä¸‹ï¼š

```python
import ctypes
from ctypes import POINTER, c_void_p, c_int, cast
import numpy as np

# å‡è®¾è¿™äº›æšä¸¾å¸¸é‡å·²å®šä¹‰
RKLLM_RUN_NORMAL = 0
RKLLM_RUN_WAITING = 1
RKLLM_RUN_FINISH = 2
RKLLM_RUN_ERROR = 3

# â€”â€” ç±»å‹å®šä¹‰ â€”â€” 
'''
 * @typedef LLMHandle
 * @brief A handle used to manage and interact with the large language model.
'''
LLMHandle = c_void_p
'''
 * @typedef LLMResultCallback
 * @brief Callback function to handle LLM results.
 * @param result Pointer to the LLM result.
 * @param userdata Pointer to user data for the callback.
 * @param state State of the LLM call (e.g., finished, error).
'''
LLMResultCallback = ctypes.CFUNCTYPE(None, POINTER(RKLLMResult), c_void_p, c_int)

# å‡è®¾ RKLLMResultã€RKLLMResultLastHiddenLayer ç­‰ç»“æ„ä½“å·²æ­£ç¡®å®šä¹‰
# LLMResultCallback ç±»å‹ä¹Ÿå·²å®šä¹‰ä¸ºï¼š
# LLMResultCallback = ctypes.CFUNCTYPE(None, POINTER(RKLLMResult), c_void_p, c_int)

def python_callback(result_ptr, userdata, state):
    if not result_ptr:
        result = None
    else:
        result = result_ptr.contents
        
    if state == RKLLM_RUN_FINISH:
        print('\n')
    elif state == RKLLM_RUN_ERROR:
        print('\\run error\n')
    elif state == RKLLM_RUN_NORMAL:
        ''' ================================================================================================================
        è‹¥ä½¿ç”¨GET_LAST_HIDDEN_LAYERåŠŸèƒ½,callbackæ¥å£ä¼šå›ä¼ å†…å­˜æŒ‡é’ˆ:last_hidden_layer,tokenæ•°é‡:num_tokensä¸éšè—å±‚å¤§å°:embd_size
        é€šè¿‡è¿™ä¸‰ä¸ªå‚æ•°å¯ä»¥å–å¾—last_hidden_layerä¸­çš„æ•°æ®
        æ³¨:éœ€è¦åœ¨å½“å‰callbackä¸­è·å–,è‹¥æœªåŠæ—¶è·å–,ä¸‹ä¸€æ¬¡callbackä¼šå°†è¯¥æŒ‡é’ˆé‡Šæ”¾
        =============================================================================================================== '''
        if result != None:
            print(result.text.decode('utf-8'), end='', flush=True)
        else:
            return

        # å¦‚æœæœ‰éšè—å±‚æ•°æ®
        embd_size = result.last_hidden_layer.embd_size
        num_tokens = result.last_hidden_layer.num_tokens
        hidden_ptr = result.last_hidden_layer.hidden_states

        if embd_size != 0 and num_tokens != 0 and hidden_ptr:
            data_size = embd_size * num_tokens
            print(f"\n[éšè—å±‚] embd_size: {embd_size}, num_tokens: {num_tokens}, æ€»å¤§å°: {data_size * 4} å­—èŠ‚")

            # å°† C æŒ‡é’ˆè½¬æ¢ä¸º numpy æ•°ç»„
            array_type = ctypes.c_float * data_size
            np_array = np.ctypeslib.as_array(cast(hidden_ptr, POINTER(array_type)).contents)
            np_array = np_array.reshape((num_tokens, embd_size))

            # ä¿å­˜ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶
            try:
                np_array.astype(np.float32).tofile("last_hidden_layer.bin")
                print("éšè—å±‚æ•°æ®å·²ä¿å­˜åˆ° last_hidden_layer.bin")
            except Exception as e:
                print(f"ä¿å­˜æ–‡ä»¶å¤±è´¥: {e}")


# å°† python_callback åŒ…è£…æˆ ctypes å‡½æ•°æŒ‡é’ˆ
cb = LLMResultCallback(python_callback)
```

1. `result.text` æ˜¯ `c_char_p`ï¼Œéœ€è¦ `.decode('utf-8')`ã€‚
2. éšè—å±‚æ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ `[num_tokens][embd_size]`ï¼Œæˆ‘ä»¬ç”¨ `numpy` æŠŠå®ƒè¿˜åŸå‡ºæ¥ã€‚
3. æ•°æ®å†™å…¥ `last_hidden_layer.bin` ä¸ C++ ç­‰æ•ˆã€‚
4. ä½ éœ€è¦æå‰åœ¨ Python ä¸­å®šä¹‰å¥½ `RKLLMResult` å’Œå…¶å†…éƒ¨ç»“æ„ä½“ã€‚
5. è‹¥ä¸ä½¿ç”¨ numpyï¼Œä¹Ÿå¯ä»¥ç”¨ Python çš„ `bytearray` æ‰‹åŠ¨å¤åˆ¶æ•°æ®ï¼Œä½† numpy æ›´é«˜æ•ˆä¸”æ–¹ä¾¿è°ƒè¯•ã€‚
6. `llmHandle` ä¸º `ctypes` çš„ `c_void_p` æˆ–å®é™…ç»“æ„ä½“æŒ‡é’ˆã€‚
7. `rkllm_destroy()` æ˜¯ä½ ç»‘å®šçš„åŸç”Ÿ C APIï¼Œç”¨ `ctypes` åŠ è½½å³å¯ã€‚
8. `sys.exit(signal)` ä¼šè®©ç¨‹åºä»¥æŒ‡å®šä¿¡å·ç é€€å‡ºã€‚
9. åœ¨ `ctypes.Structure` ä¸­ï¼Œå­—æ®µæœªèµ‹å€¼æ—¶é»˜è®¤æ˜¯ 0ï¼Œä½†ä¸ºäº†å®Œå…¨å¯¹åº” C çš„ `memset(&x, 0, sizeof(x))`ï¼Œæˆ‘ä»¬è°ƒç”¨äº† `ctypes.memset`ã€‚
10. å¦‚æœä½ ä¸ç¡®å®šç»“æ„ä½“å­—æ®µï¼Œåªå£°æ˜ç»“æ„ä½“æ—¶ `memset` ä¹Ÿå¯æ¸…é›¶æ‰€æœ‰æœªåˆå§‹åŒ–å†…å­˜ã€‚
11. `ctypes.byref` è·å–ç»“æ„ä½“å¼•ç”¨ï¼Œé€‚ç”¨äºç±»ä¼¼ `memset(&obj, ...)` çš„è°ƒç”¨åœºæ™¯ã€‚

---

### armbianç³»ç»Ÿç›¸å…³

æœ€åè¯´ä¸€è¯´armbian Debian 12 (Bookworm)ï¼Œè“ç‰™ä½“éªŒéå¸¸å¥½ï¼Œæœç„¶æ¯”å®˜æ–¹ç³»ç»Ÿå¥½ç”¨ï¼å¾ˆå¤šè½¯ä»¶å’Œä¾èµ–éƒ½å¯ä»¥ç›´æ¥`sudo apt install`è£…å®Œå³ç”¨ã€‚å…ˆæ¥è¯´è¯´è¿ç§»ç³»ç»Ÿåçš„ä¸€äº›é—®é¢˜ï¼š

1. æ›´æ”¹è¯­è¨€åï¼Œåœ¨`~/.xsessionrc`å’Œ`~/.bashrc`é‡Œä¹Ÿè¦æ›´æ”¹å¯¹åº”çš„localesã€‚

2. nmcliåˆ›å»ºçš„çƒ­ç‚¹éœ€è¦å®‰è£…`dnsmasq`åæ‰èƒ½æˆåŠŸå¼€å¯

3. æ— å±æ¨¡å¼
    ```bash
    sudo systemctl set-default multi-user.target
    ```

4. å®‰è£…Cockpitï¼Œä½¿ç”¨`armbian-config`é€‰æ‹©`Software-Management-Cockpit`å®‰è£…

5. dockerå®‰è£…å‡ºé”™ï¼ŒæŒ‰ç…§ä¸Šé¢å®˜æ–¹é•œåƒä¸€æ ·å®‰è£…ä¼šå‡ºé”™ï¼Œéœ€è¦å®‰è£…
    ```bash
    sudo apt update
    sudo apt install apparmor-utils
    sudo systemctl restart docker
    ```

6. ç½‘ç»œéƒ¨åˆ†ï¼Œå‚è€ƒ[debianå®˜æ–¹æ–‡æ¡£](https://wiki.debian.org/NetworkConfiguration)

7. RDPéƒ¨åˆ†å®‰è£…ï¼š
    ```bash
    sudo apt update
    sudo apt install -y xfce4 xfce4-goodies
    sudo apt install -y xrdp xorgxrdp xserver-xorg-core xserver-xorg-video-fbdev
    echo startxfce4 > ~/.xsession
    chmod +x ~/.xsession
    ```
8. dockerå®¹å™¨è¿wifi
    ```bash
    docker run -d --name openwrt --network none --restart unless-stopped -v /home/lyc/Workspace/easytier-linux-aarch64:/data2 --privileged kiddin9/openwrt /sbin/init
    sudo ip link add veth-host type veth peer name veth-openwrt
    sudo ip addr add 192.168.166.1/24 dev veth-host
    sudo ip link set veth-host up
    PID=$(docker inspect -f '\{\{.State.Pid\}\}' openwrt)
    sudo ip link set veth-openwrt netns $PID
    sudo nsenter -t $PID -n ip addr add 192.168.166.2/24 dev veth-openwrt
    sudo nsenter -t $PID -n ip link set veth-openwrt up
    sudo nsenter -t $PID -n ip route add default via 192.168.166.1
    ```
    åœ¨å®¹å™¨é‡Œé¢å…ˆç”¨`passwd`æ”¹å¯†ç ï¼Œæ¥ä¸‹æ¥ç¼–è¾‘`/etc/config/network`æ–‡ä»¶ï¼ŒåŠ å…¥ä¸‹é¢çš„éƒ¨åˆ†ï¼š
    ```bash
    config device
        option name 'veth-openwrt'
        option type 'ethernet'
    
    config interface 'wan'
        option device 'veth-openwrt'
        option proto 'static'
        option ipaddr '192.168.166.2'
        option netmask '255.255.255.0'
        option gateway '192.168.166.1'
        option ip6assign '60'
    ```
    ã€‚ç„¶åè¿è¡Œ`/etc/init.d/network restart`é‡å¯ç½‘ç»œã€‚å…³é—­é˜²ç«å¢™`etc/init.d/firewall stop`åå°±å¯ä»¥è®¿é—®ç½‘é¡µ`https://192.168.166.2`æ¥æ‰“å¼€Luciç½‘é¡µäº†ã€‚ä¸ºäº†è”ç½‘éœ€è¦å¼€å¯NATè½¬å‘

    ```bash
    echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward
    sudo iptables -t nat -A POSTROUTING -s 192.168.166.0/24 -o wlx0c82680ba357 -j MASQUERADE
    ```

    ç¦ç”¨ docker çš„é»˜è®¤ FORWARD é™åˆ¶ï¼ŒæŸ¥çœ‹æ˜¯å¦è¢« `FORWARD` ç­–ç•¥é˜»æŒ¡ï¼š

    ```bash
    sudo iptables -L FORWARD
    ```

    å¦‚æœé»˜è®¤æ˜¯ `DROP`ï¼Œè¯·è®¾ç½®ä¸º `ACCEPT`ï¼š

    ```bash
    sudo iptables -P FORWARD ACCEPT
    ```

    ä¸ºäº†è½¬å‘å±€åŸŸç½‘çš„ç«¯å£ï¼Œæ¥ä¸‹æ¥å¯è¡Œçš„æ“ä½œå°±å¾ˆå¤šäº†ï¼Œä¸€ä¸ªä¸ªä»‹ç»ä¸€ä¸‹å§ã€‚

    + Cloudflared

        é¦–å…ˆå®‰è£…ä¸€ä¸‹
        ```bash
        opkg update
        opkg install cloudflared
        cloudflared update
        ```
        ç„¶åå¼€å§‹ç™»å½•
        ```bash
        cloudflared tunnel login
        ```
        è¿™ä¸ªå‘½ä»¤ä¼šåœ¨ç»ˆç«¯ä¸­æ˜¾ç¤ºä¸€ä¸ª URLï¼Œä½ éœ€è¦åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€å¹¶æˆæƒç™»å½• Cloudflare è´¦å·ã€‚æ¥ä¸‹æ¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ tunnelï¼š
        ```bash
        cloudflared tunnel create <your-tunnel-name>
        ```
        è¿™ä¸ªå‘½ä»¤ä¼šç”Ÿæˆä¸€ä¸ª tunnel_idï¼Œåç»­éœ€è¦ç”¨åˆ°ã€‚é…ç½®æ–‡ä»¶ä¸€èˆ¬ä¿å­˜åœ¨ /etc/cloudflared/config.yml ä¸­ï¼Œè‹¥æ²¡æœ‰æ­¤æ–‡ä»¶ï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»ºã€‚
        ```bash
        nano /etc/cloudflared/config.yml
        ```
        åœ¨æ–‡ä»¶ä¸­ï¼Œé…ç½®ä½ çš„ tunnel_id å’Œè¦ä»£ç†çš„æœåŠ¡ï¼ˆä¾‹å¦‚ OpenWrt çš„ Web ç®¡ç†ç«¯å£ï¼‰ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š
        ```yaml
        tunnel: <your-tunnel-id>
        credentials-file: /etc/cloudflared/<your-tunnel-id>.json
        
        ingress:
        - hostname: <your-subdomain>.example.com
            service: ssh://10.12.0.3:22  # è¿™é‡Œæ˜¯ä½ çš„ OpenWrt åœ°å€å’Œç«¯å£
        - service: http_status:404
        ```
        `your-tunnel-id` æ˜¯ä½ é€šè¿‡ `cloudflared tunnel create` å‘½ä»¤ç”Ÿæˆçš„ Tunnel IDã€‚
        `hostname` æ˜¯ä½ æƒ³åœ¨ Cloudflare ä¸Šé…ç½®çš„åŸŸåï¼Œæ³¨æ„ä½ éœ€è¦æå‰å°†è¯¥å­åŸŸçš„ DNS è§£æè®¾ç½®ä¸º Cloudflare ä»£ç†ã€‚
        `service` æ˜¯ä½ æƒ³é€šè¿‡ Tunnel ä»£ç†çš„æœåŠ¡åœ°å€ï¼Œè¿™é‡Œæ˜¯å†…ç½‘æŸä¸»æœºsshæœåŠ¡ `10.12.0.3:22`ã€‚
        é…ç½®å¥½ä¹‹åï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ Tunnelï¼š
        ```bash
        cloudflared tunnel run <your-tunnel-name>
        ```

    + frpæœåŠ¡
        æœ¬æœåŠ¡éœ€è¦æœ‰å…¬ç½‘IPï¼Œå°†æœ¬åœ°å†…ç½‘çš„æŸä¸ªæœåŠ¡ç»‘å®šåˆ°å…¬ç½‘IPçš„æŸä¸€ç«¯å£ã€‚åŒ…æ‹¬frpcå’Œfrpsä¸¤ä¸ªéƒ¨åˆ†ã€‚ä¸€èˆ¬frpséƒ¨ç½²åœ¨å…·æœ‰å…¬ç½‘IPçš„æœºå™¨ä¸Šï¼Œså³æ˜¯serverã€‚å…ˆä¸‹è½½æ–‡ä»¶

        ```bash
        wget https://github.com/fatedier/frp/releases/download/v0.62.1/frp_0.62.1_linux_arm64.tar.gz
        tar -zxvf frp_0.62.1_linux_arm64.tar.gz 
        ```
        ç„¶ååœ¨ä¸Šé¢è¿›è¡Œå¼€å¯frpæœåŠ¡ï¼Œå…ˆå†™å…¥é…ç½®æ–‡ä»¶`frp.ini`ä¸‹é¢çš„å†…å®¹ï¼š
        ```yaml
        [common]
        bind_port = 7000
        dashboard_port = 7500
        dashboard_user = admin
        dashboard_pwd = admin
        token = set_your_token
        ```
        ä¹‹åå¼€å¯æœåŠ¡ï¼š
        ```bash
        nohup ./frps -c ./frp.ini > log.txt 2>&1 &
        ```
        æ¥ä¸‹æ¥é…ç½®frpå®¢æˆ·ç«¯ã€‚ç›´æ¥åœ¨ç½‘é¡µä¸ŠSystem-SOftwareé‡Œä¸‹è½½luci-frpc-appç„¶ååœ¨ç½‘é¡µè¿›è¡Œé…ç½®å³å¯ã€‚ä¹Ÿå¯ä»¥å°†frpsé…ç½®ä¸ºsystemdç³»ç»ŸæœåŠ¡ï¼Œå°±ä¸ç”¨æ¯æ¬¡ä½¿ç”¨å‘½ä»¤
        è‡ªå·±å¯åŠ¨äº†ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ã€‚å…ˆåˆ›å»ºæ–‡ä»¶`/etc/systemd/system/frps.service`ï¼Œç„¶åå¡«å…¥ä¸‹é¢çš„å†…å®¹ï¼Œè·¯å¾„è‡ªè¡Œä¿®æ”¹ï¼š
        ```bash
        [Unit]
        Description=Frp Server Service
        After=network.target

        [Service]
        Type=simple
        User=root
        Restart=on-failure
        RestartSec=5s
        ExecStart=/path/to/frps -c /path/to/frps/config/file.ini

        [Install]
        WantedBy=multi-user.target
        ```
        ç„¶åä½¿ç”¨`sudo systemctl daemon-reload`æ¥åŠ è½½æ–°çš„æœåŠ¡å•å…ƒï¼Œä½¿ç”¨`sudo systemctl start frps`æ¥å¯åŠ¨æœåŠ¡ï¼Œä½¿ç”¨`sudo systemctl enable frps`æ¥å¼€æœºå¯åŠ¨ã€‚

    + socatæœåŠ¡

      ç›¸æ¯”ä¹‹ä¸‹socatæœåŠ¡æ›´ç®€å•ï¼Œåªéœ€è¦æ¥åˆ°iStoreOSæ¥å®‰è£…ä¸€ä¸‹Socatã€‚ä½†æ˜¯å®¹å™¨æœ¬èº«éœ€è¦é…ç½®ç«¯å£æ˜ å°„ï¼Œå°†ä¸€äº›ç«¯å£æ˜ å°„åˆ°å®¹å™¨å¤–ã€‚æ­¤æ—¶å¦‚æœå®¿ä¸»æœºæœ¬èº«å°±æœ‰å…¬ç½‘IPçš„è¯ï¼Œå°±å¯ä»¥å°†ç«¯å£ç›´æ¥æ˜ å°„åˆ°åŸŸå+ç«¯å£äº†ã€‚æœ€åå»ç½‘é¡µiStoreå®‰è£…socatï¼Œé€šè¿‡ç½‘é¡µæ¥å£è®¾ç½®ç«¯å£è½¬å‘åŠŸèƒ½ã€‚å¦å¤–å¯ä»¥åœ¨ç½‘é¡µçš„`System-Software`é‡Œé¢å®‰è£…**lua-app-easytire**å’Œ**easytire**æ¥å¼€å¯ç»„ç½‘ã€‚

9. dockerå®¹å™¨å®‰è£…sshï¼Œå¯ç”¨gpuæ”¯æŒ

    ```
    docker run -it --gpus all  --name pydev  -v /data/yanchaoliu:/data2 --privileged -p 65530:65530 -p 65531:65531 -p 65532:65532 ubuntu:latest /bin/bash
    ```

    è¿›å»å°±å¯ä»¥ä½¿ç”¨å‘½ä»¤`nvidia-smi`æŸ¥çœ‹gpuæƒ…å†µã€‚ç„¶åå®‰è£…adduserå’Œsudoï¼Œ

    ```bash
    apt install -y adduser sudo nano
    ```

    åˆ›å»ºç”¨æˆ·lycï¼Œå¹¶åŠ å…¥sudoæƒé™

    ```bash
    adduser lyc
    usermod -aG sudo lyc
    ```

    åŠ å…¥å…¬é’¥

    ```bash
    su lyc
    mkdir ~/.ssh
    cd ~/.ssh
    touch authorized_keys
    nano authorized_keys # åŠ å…¥å…¬é’¥åˆ°æ–‡ä»¶
    chmod 600 authorized_keys
    ```

    ç„¶åå®‰è£…sshæœåŠ¡ï¼Œç¼–è¾‘é…ç½®æ–‡ä»¶

    ```bash
    sudo apt install openssh-server
    sudo nano /etc/ssh/sshd_config
    sudo mkdir /var/run/sshd
    sudo /etc/init.d/ssh start
    ```
